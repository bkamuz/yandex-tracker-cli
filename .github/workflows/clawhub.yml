name: Publish to ClawHub
on:
  push:
    branches: [ main, master ]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install clawhub
        run: npm install -g clawhub
      - name: Bump version (each segment 0-9, carry on overflow)
        id: bump
        run: |
          CUR=$(jq -r '.version' _meta.json | tr -d '\n\r')
          IFS=. read -ra P <<< "$CUR"
          i=$((${#P[@]} - 1))
          P[i]=$((${P[i]} + 1))
          while (( i > 0 && P[i] > 9 )); do P[i]=0; i=$((i-1)); P[i]=$((${P[i]} + 1)); done
          (( P[0] > 9 )) && P[0]=0
          NEW=$(IFS=.; echo "${P[*]}" | tr -d '\n\r')
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "$NEW" > version.txt
          echo "Bumped $CUR -> $NEW"
          jq --arg v "$NEW" '.version = $v' _meta.json > _meta.json.tmp && mv _meta.json.tmp _meta.json
      - name: Publish to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: |
          bump_next() {
            local cur=$1
            IFS=. read -ra P <<< "$cur"
            i=$((${#P[@]} - 1))
            P[i]=$((${P[i]} + 1))
            while (( i > 0 && P[i] > 9 )); do P[i]=0; i=$((i-1)); P[i]=$((${P[i]} + 1)); done
            (( P[0] > 9 )) && P[0]=0
            IFS=.; echo "${P[*]}" | tr -d '\n\r'
          }
          clawhub login --token "$CLAWHUB_TOKEN"
          for attempt in 1 2 3 4 5; do
            VERSION=$(tr -d '\n\r' < version.txt)
            set +e
            out=$(clawhub publish . --slug yandex-tracker-cli --name "Yandex Tracker CLI" --version "$VERSION" --tags "bash,curl,yandex,tracker,cli" 2>&1)
            code=$?
            set -e
            echo "$out"
            if echo "$out" | grep -q "Version already exists"; then
              NEW=$(bump_next "$VERSION")
              echo "Version $VERSION exists, retrying with $NEW"
              echo "$NEW" > version.txt
              jq --arg v "$NEW" '.version = $v' _meta.json > _meta.json.tmp && mv _meta.json.tmp _meta.json
            elif [ "$code" -ne 0 ]; then
              exit 1
            else
              exit 0
            fi
          done
          echo "Publish failed after 5 attempts"
          exit 1
      - name: Commit version bump
        run: |
          VERSION=$(tr -d '\n\r' < version.txt)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _meta.json
          git diff --staged --quiet || ( git commit -m "chore: bump version to $VERSION" && git push )
